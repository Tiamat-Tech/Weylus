#!/usr/bin/env bash

# Resolves each ref in refs.sh to a commit hash and writes hashes.sh.

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/refs.sh"

resolve() {
    local name="$1" url="$2" ref="$3"
    local hash
    hash=$(git ls-remote "$url" "$ref" | awk 'END { print $1 }')
    if [ -z "$hash" ]; then
        echo "ERROR: could not resolve $name $ref from $url" >&2
        exit 1
    fi
    echo "${name}_COMMIT=\"${hash}\"  # ${ref}"
}

cat > "$SCRIPT_DIR/hashes.sh" <<EOF
#!/usr/bin/env bash

# Generated by update_hashes.sh â€” do not edit manually.
# Run ./update_hashes.sh to regenerate.

$(resolve X264      "$X264_URL"     "$X264_REF")
$(resolve FFMPEG    "$FFMPEG_URL"   "$FFMPEG_REF")
$(resolve NV_CODEC  "$NV_CODEC_URL" "$NV_CODEC_REF")
$(resolve LIBVA     "$LIBVA_URL"    "$LIBVA_REF")
EOF

echo "hashes.sh updated."
